<!DOCTYPE html>
<html>

<head></head>

<body>

    <div id="uploader" class="wu-example">
        <!--用来存放文件信息-->
        <div id="thelist" class="uploader-list"></div>
        <div class="btns">
            <div id="picker">选择文件</div>
        </div>
    </div>
    <script src="./jquery-1.11.3.min.js"></script>
    <script src="./sha1.js"></script>
    <script src="./webuploader-0.1.5/webuploader.min.js"></script>
    <script>
        var fm = [];
        WebUploader.Uploader.register({
            "before-send-file": "beforeSendFile",
            "before-send": "beforeSend"
        }, {
                "beforeSendFile": function (file) {
                    var _this = this.owner;
                    var deferred = WebUploader.Deferred();

                    //1、计算文件的唯一标记，用于断点续传 
                    (new WebUploader.Uploader()).md5File(file, 0, 10 * 1024 * 1024)
                        .progress(function (percentage) {
                            console.log("正在读取文件");
                        })
                        .then(function (val) {
                            $.ajax({
                                url: _this.options.server, type: 'POST', async: false, cache: false, contentType: false, processData: false,
                                data: {
                                    periodMinute: 0,
                                    hash: val,
                                    ownerToken: '2HGNr048HJPZ8MFLRenwpgeAjurwCAAAAAQAAAAEAAAAAXNdzOA',
                                    fileName: file.name
                                },
                                success: function (returndata) {
                                    console.info("sssss", returndata);
                                    _this.options.formData = $.extend(_this.options.formData, {
                                        periodMinute: 0,
                                        hash: val,
                                        ownerToken: '2HGNr048HJPZ8MFLRenwpgeAjurwCAAAAAQAAAAEAAAAAXNdzOA',
                                        fileName: file.name
                                    });
                                    console.log("成功获取文件信息……");
                                    //获取文件信息后进入下一步 
                                    deferred.resolve();
                                },
                                error: function (returndata) {
                                    console.info("eeeeee", returndata);
                                }
                            });


                        });
                    return deferred.promise();
                },
                "beforeSend": function (block) {
                    var deferred = WebUploader.Deferred();
                    var fileUpload = $("#picker").find(':input[type="file"]').get(0);

                    var files = fileUpload.files;
                    var data = new FormData();
                    for (var i = 0; i < files.length; i++) {
                        data.append(files[i].name, files[i]);
                    }
                    this.options.formData = $.extend(this.options.formData, { file: data });
                    var curChunk = block.chunk;
                    var totalChunk = block.chunks;
                    // if (chunkObj.type == "1") {
                    //     if (curChunk < chunkObj.chunk) {
                    //         deferred.reject();
                    //     } else {
                    //         deferred.resolve();
                    //     }
                    // } else {
                    //     deferred.resolve();
                    // }
                    deferred.resolve();
                    return deferred.promise();
                }
            });

        var uploader = WebUploader.create({
            pick: {
                id: '#picker',
                //label: '点击选择文件'
            },
            auto: true,
            swf: './webuploader-0.1.5/Uploader.swf',
            chunked: true, //分片处理大文件
            chunkSize: 1 * 1024 * 1024,
            server: 'http://localhost:5000/files',
            disableGlobalDnd: true,
            threads: 1, //上传并发数
            fileNumLimit: 300,
            compress: false, //图片在上传前不进行压缩
            fileSizeLimit: 1024 * 1024 * 1024,    // 1024 M
            fileSingleSizeLimit: 1024 * 1024 * 1024    // 1024 M
        }).on("error", function (code, file) {
            var name = file.name;
            switch (code) {
                case "F_DUPLICATE":
                    str = name + "文件重复";
                    break;
                case "Q_TYPE_DENIED":
                    str = name + "文件类型 不允许";
                    break;
                case "F_EXCEED_SIZE":
                    var imageMaxSize = 9;//通过计算
                    str = name + "文件大小超出限制" + imageMaxSize + "M";
                    break;
                case "Q_EXCEED_SIZE_LIMIT":
                    str = "超出空间文件大小";
                    break;
                case "Q_EXCEED_NUM_LIMIT":
                    str = "抱歉，超过每次上传数量图片限制";
                    break;
                default:
                    str = name + " Error:" + code;
            }
            alert(str);
        }).on("uploadSuccess", function (file, response) {
            console.info("uploadSuccess", file, response, this.getFile(file.id));
        }).on("uploadProgress", function (file, percent) {//一般用此事件做页面信息提示
            console.info('xxx', this.getFile(file.id));
            return true;
            //trtds.find('.progressDiv span').html(percent == 1 ? '正在合并文件' : (percent < 0 ? ' 计算md5进度:' : ' 上传进度:') + Math.floor(percent * 100));
        }).on("beforeFileQueued", function (file) {
            console.info('xxx1', this.getFile(file.id));
            return true;
            //return false;  //阻止该文件上传
        }).on('fileQueued', function (file) {
            uploader.md5File(file)
                // 及时显示进度
                .progress(function (percentage) {
                    console.log('Percentage:', percentage);
                })

                // 完成
                .then(function (val) {
                    console.log('md5 result:', val);
                });

            console.log('sha1 result:', sha1(file));
        });

        // uploader.on('uploadAccept', function (file, response) {
        //     if (file.chunk + 1 !== file.chunks) {
        //         $.extend(uploader.options.formData, { previosName: response.filePath });
        //     } else {
        //         $.extend(uploader.options.formData, { previosName: "" });
        //     }
        //     return true;
        // });
    </script>
</body>

</html>